# appveyor.yml reference see https://www.appveyor.com/docs/appveyor-yml/

#---------------------------------#
#      general configuration      #
#---------------------------------#

# version format
version: 1.1.0.{build}

#---------------------------------#
#    environment configuration    #
#---------------------------------#

# Build worker image (VM template)
image: Visual Studio 2017

# build cache to preserve files/folders between builds
  - cmd: mvn versions:set -DnewVersion=%APPVEYOR_BUILD_VERSION%

# enable patching of AssemblyInfo.* files
assembly_info:
  patch: true
  file: '**\AssemblyInfo.*'
  assembly_version: "{version}"
  assembly_file_version: "{version}"
cache:
  - C:\Users\appveyor\.m2

# scripts that run after cloning repository
install:
  - cmd: path
  - cmd: set Java
  - cmd: set

#---------------------------------#
#       build configuration       #
#---------------------------------#

# build Configuration, i.e. Debug, Release, etc.
configuration: Release

# Build settings, not to be confused with "before_build" and "after_build".
# "project" is relative to the original build directory and not influenced by directory changes in "before_build".
#build:

# scripts to run before build
#before_build:

# to run your custom scripts instead of automatic MSBuild
build_script:
  - dotnet build FsSonarRunner\FsSonarRunner.sln
  - mvn clean

# scripts to run after build (working directory and environment changes are persisted from the previous steps)
#after_build:

# scripts to run *after* solution is built and *before* automatic packaging occurs (web apps, NuGet packages, Azure Cloud Services)
#before_package:

#---------------------------------#
#       tests configuration       #
#---------------------------------#

# to run tests against only selected assemblies and/or categories
#test:

# scripts to run before tests (working directory and environment changes are persisted from the previous steps such as "before_build")
before_test:

# to run your custom scripts instead of automatic tests
test_script:
  - dotnet test FsSonarRunner\FsSonarRunner.sln

# scripts to run after tests
after_test:
  - ps: |
      $url = "https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)"
      $wc = New-Object 'System.Net.WebClient'
      $files = Get-ChildItem -Recurse .\TEST-*.xml
      foreach ($f in $files) {
        $wc.UploadFile($url, (Resolve-Path $f))
      }

# to disable automatic tests
#test: off

#---------------------------------#
#      artifacts configuration    #
#---------------------------------#

artifacts:
  - path: 'sonar-fsharp-plugin/target/*.jar'
    name: sonar-fsharp-plugin

#---------------------------------#
#     deployment configuration    #
#---------------------------------#

#---------------------------------#
#        global handlers          #
#---------------------------------#

#---------------------------------#
#         notifications           #
#---------------------------------#
